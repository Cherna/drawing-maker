# Pipeline API Documentation

The Pipeline API is a flexible, step-based system for generating and modifying drawings. It allows you to chain together generators, modifiers, and transforms with powerful procedural masking.

## Overview

The pipeline executes a series of steps in order. Each step can be:
- **Generator**: Creates new geometry (stripes, grid, spiral, etc.)
- **Modifier**: Transforms existing geometry (noise, trim, warp, etc.)

Modifiers can use **masks** to control where effects are applied. Masks can be simple geometric shapes or complex procedural patterns generated by noise.

## Configuration Structure

```json
{
  "sketch": "pipeline",
  "canvas": {
    "width": 200,
    "height": 300,
    "margin": 20
  },
  "params": {
    "seed": 42,
    "steps": [
      { "tool": "stripes", "params": { "lines": 100 } },
      { "tool": "resample", "params": { "res": 0.5 } },
      {
        "tool": "noise",
        "params": { "scale": 0.05, "magnitude": 5 },
        "mask": { "type": "noise", "params": { "scale": 0.02 } }
      }
    ]
  }
}
```

## Reproducibility with Seeds

Add a `seed` parameter for reproducible results:
- **Global seed**: Set `seed` in `params` to seed all steps
- **Per-step seed**: Set `seed` in individual step `params` to override
- **Per-mask seed**: Set `seed` in mask `params` for mask-specific seeding

## Available Generators

### `stripes`
Horizontal lines across the draw area.
- `lines` (number): Number of lines

### `vertical-stripes`
Vertical lines across the draw area.
- `lines` (number): Number of lines

### `grid`
Horizontal and vertical lines forming a grid.
- `lines` or `linesX`, `linesY` (number): Line count

### `concentric`
Concentric circles from center.
- `count` (number): Number of circles
- `centerX`, `centerY` (0-1): Center position
- `minRadius` (number): Starting radius

### `spiral`
Spiral pattern from center.
- `turns` (number): Number of spiral turns
- `pointsPerTurn` (number): Smoothness (default: 36)
- `direction` ('cw' | 'ccw'): Spiral direction

### `radial`
Lines radiating from center.
- `count` (number): Number of radial lines
- `innerRadius`, `outerRadius` (0-1): Line extent

### `waves`
Sinusoidal horizontal lines.
- `lines` (number): Number of wave lines
- `amplitude` (number): Wave height
- `frequency` (number): Waves per width
- `phase` (0-1): Starting phase

### `hatching`
Diagonal hatching lines.
- `lines` (number): Line density
- `angle` (degrees): Hatch angle (default: 45)
- `bidirectional` (boolean): Cross-hatch

## Available Modifiers

### `resample`
Converts paths into small segments. **Required before noise/warp**.
- `res` (number): Segment length in mm

### `noise`
Applies Perlin noise displacement.
- `scale` (number): Noise frequency
- `magnitude` (number): Displacement strength
- `axis` ('x' | 'y' | 'both'): Displacement direction
- `seed` (number): Random seed
- `octaves` (number): Layers of noise (turbulence effect)
- `persistence` (number): Amplitude decay per octave
- `lacunarity` (number): Frequency growth per octave

### `trim`
Probabilistically removes paths based on mask value.
- `threshold` (number): Not currently used (mask controls probability)
- `seed` (number): Random seed

### `scale`
Scales the model.
- `scale` or `x` (number): X scale factor
- `y` (number): Y scale factor (defaults to x)

### `simplify`
Removes very short line segments.
- `tolerance` (number): Minimum segment length

### `warp`
Applies geometric distortion.
- `type` ('bulge' | 'pinch' | 'twist' | 'wave'): Warp type
- `strength` (number): Effect intensity
- `frequency` (number): For wave type

### `rotate`
Rotates around center.
- `rotation` (degrees): Rotation angle

### `move`
Translates the model.
- `x`, `y` (number): Offset in mm

### `clone`
Creates a copy and applies sub-steps.
- `steps` (array): Steps to apply to clone

### `duplicate`
Creates a copy of the current state as a separate layer. Useful for moire patterns.
- `id` (string, optional): Layer identifier

**Example for moire pattern**:
```json
{
  "steps": [
    { "tool": "stripes", "params": { "lines": 100 } },
    { "tool": "resample", "params": { "res": 0.5 } },
    { "tool": "noise", "params": { "scale": 0.05, "magnitude": 3 } },
    { "tool": "duplicate", "params": { "id": "layer2" } },
    { "tool": "rotate", "params": { "rotation": 2.5 } }
  ]
}
```

### `layer`
Creates a duplicate and applies a sub-pipeline to it. More convenient than `duplicate` + manual steps.
- `id` (string, optional): Layer identifier
- `steps` (array): Steps to apply to the layer

**Example for moire pattern**:
```json
{
  "tool": "layer",
  "params": {
    "id": "rotated",
    "steps": [
      { "tool": "rotate", "params": { "rotation": 2.5 } }
    ]
  }
}
```

## Masks

Masks control where effects are applied, returning values from 0 (no effect) to 1 (full effect).

### Geometric Masks

#### `radial`
Circular gradient from center.
- `center` ([x, y]): Normalized position (0-1)
- `radius` (0-1): Falloff radius
- `falloff` ('linear' | 'smooth' | 'sharp')

#### `linear`
Linear gradient along an axis.
- `angle` (degrees): Gradient direction
- `offset` (number): Shift gradient position

#### `border`
Feathers from all edges.
- `top`, `right`, `bottom`, `left` (0-1): Feather distances
- `centerRadius` (0-1): Unaffected center area

### Procedural Masks

#### `noise`
Simplex noise - organic, cloud-like patterns.
- `scale` (number): Noise frequency (smaller = larger features)
- `contrast` (number): Intensify differences (default: 1)
- `bias` (number): Shift overall brightness
- `offsetX`, `offsetY` (number): Offset sampling position
- `seed` (number): Random seed

#### `turbulence`
Multi-octave fractal noise - detailed, natural patterns.
- `scale` (number): Base frequency
- `octaves` (number): Layers of detail (default: 4)
- `persistence` (number): Amplitude decay (default: 0.5)
- `lacunarity` (number): Frequency growth (default: 2)
- `contrast`, `seed`: Same as noise

#### `cells`
Voronoi/cellular pattern - organic cell-like shapes.
- `scale` (number): Cell size
- `type` ('f1' | 'f2' | 'f2-f1'): f1 = distance to nearest, f2-f1 = cell edges
- `jitter` (0-1): Randomness of cell centers
- `seed` (number): Random seed

#### `waves`
Sine wave stripes.
- `scale` (number): Wave frequency
- `angle` (degrees): Wave direction
- `waveform` ('sine' | 'square' | 'triangle')

#### `checker`
Checkerboard grid.
- `scale` or `scaleX`, `scaleY` (number): Square size
- `softness` (0-1): Edge softness

### Mask Modifiers

Each mask can have these post-processing options:

- `invert` (boolean): Flip 0↔1
- `threshold` (number): Convert to hard edge at this value
- `remap` ([min, max]): Remap output range

### Combining Masks

Pass an array of masks to combine them:

```json
"mask": [
  { "type": "noise", "params": { "scale": 0.02 } },
  { "type": "radial", "params": { "radius": 0.6 }, "op": "max" }
]
```

**Combination operations** (`op`):
- `multiply` (default): Multiply values (both must be high)
- `add`: Add values (clamped to 1)
- `subtract`: Subtract second from first
- `max`: Take maximum (either can contribute)
- `min`: Take minimum (both must contribute)
- `screen`: Like Photoshop screen blend

## Margin System

The `margin` configuration defines the safe drawing area. The generated art is automatically scaled to fit and centered.

**Format:**
- Single number: `20` → all sides
- Two numbers: `[20, 10]` → [vertical, horizontal]
- Four numbers: `[top, right, bottom, left]`

## Complete Examples

### Basic Noise Pattern
```json
{
  "steps": [
    { "tool": "stripes", "params": { "lines": 100 } },
    { "tool": "resample", "params": { "res": 0.5 } },
    { "tool": "noise", "params": { "scale": 0.05, "magnitude": 5 } }
  ]
}
```

### Procedural Mask with Turbulence
```json
{
  "seed": 42,
  "steps": [
    { "tool": "stripes", "params": { "lines": 150 } },
    { "tool": "resample", "params": { "res": 0.5 } },
    { "tool": "noise", "params": { "scale": 0.08, "magnitude": 8 } },
    {
      "tool": "trim",
      "mask": {
        "type": "turbulence",
        "params": { "scale": 0.03, "octaves": 4, "contrast": 1.5 },
        "threshold": 0.5
      }
    }
  ]
}
```

### Combined Masks
```json
{
  "steps": [
    { "tool": "hatching", "params": { "lines": 80, "bidirectional": true } },
    { "tool": "resample", "params": { "res": 1 } },
    {
      "tool": "noise",
      "params": { "scale": 0.04, "magnitude": 4 },
      "mask": [
        { "type": "cells", "params": { "scale": 0.08, "type": "f1" }, "remap": [0.3, 1] },
        { "type": "border", "params": { "top": 0.15, "bottom": 0.15 }, "op": "multiply" }
      ]
    }
  ]
}
```

### Spiral with Radial Mask
```json
{
  "steps": [
    { "tool": "spiral", "params": { "turns": 25 } },
    {
      "tool": "noise",
      "params": { "scale": 0.1, "magnitude": 3 },
      "mask": { "type": "radial", "params": { "radius": 0.8, "falloff": "smooth" }, "invert": true }
    }
  ]
}
```

## Tips

1. **Always resample before noise/warp**: These effects need paths broken into segments.

2. **Use procedural masks for organic effects**: Noise and turbulence masks create natural-looking variations.

3. **Combine masks for complex effects**: Use geometric masks to constrain procedural ones.

4. **Use seeds for reproducibility**: Same seed = same output every time.

5. **Threshold for hard edges**: Add `"threshold": 0.5` to convert soft masks to sharp boundaries.

6. **Remap for control**: Use `"remap": [0.2, 0.8]` to reduce the range of an effect.
